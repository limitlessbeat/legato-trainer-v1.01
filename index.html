<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2685.2">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1">&lt;!DOCTYPE html&gt;</p>
<p class="p1">&lt;html lang="en"&gt;</p>
<p class="p1">&lt;head&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta charset="UTF-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta name="apple-mobile-web-app-capable" content="yes"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;title&gt;Legato Trainer v38 - Label Fixed&lt;/title&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>/* --- v38 STYLE --- */</p>
<p class="p1"><span class="Apple-converted-space">        </span>:root {</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-bg: #000000;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-panel: #111111;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-border: #333333;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-text: #ffffff;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-sub: #888888;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-accent: #007bff;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-good: #4cd964;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-warn: #ffcc00;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-bad: #ff3b30;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-poor: #666;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>body {</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-family: "SF Mono", "Roboto Mono", -apple-system, BlinkMacSystemFont, sans-serif;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: var(--c-bg);</p>
<p class="p1"><span class="Apple-converted-space">            </span>color: var(--c-text);</p>
<p class="p1"><span class="Apple-converted-space">            </span>margin: 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex;</p>
<p class="p1"><span class="Apple-converted-space">            </span>flex-direction: column;</p>
<p class="p1"><span class="Apple-converted-space">            </span>height: 100dvh;</p>
<p class="p1"><span class="Apple-converted-space">            </span>overflow: hidden;</p>
<p class="p1"><span class="Apple-converted-space">            </span>user-select: none;</p>
<p class="p1"><span class="Apple-converted-space">            </span>-webkit-user-select: none;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* HEADER */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.header {</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 12px 15px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex; justify-content: space-between; align-items: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-bottom: 1px solid var(--c-border);</p>
<p class="p1"><span class="Apple-converted-space">            </span>flex-shrink: 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>z-index: 10; background: var(--c-bg);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>h1 { margin: 0; font-size: 0.9rem; font-weight: 800; letter-spacing: 1px; color: #ccc; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.mode-select {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: #222; color: #fff; border: 1px solid #444;</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 6px 10px; border-radius: 6px; font-size: 0.8rem; outline: none;</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-weight: bold;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* METRONOME AREA */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.metronome-area {</p>
<p class="p1"><span class="Apple-converted-space">            </span>height: 220px;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>background: radial-gradient(circle at center bottom, #1a1a1a, #000);</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-bottom: 1px solid var(--c-border);</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: relative;</p>
<p class="p1"><span class="Apple-converted-space">            </span>overflow: hidden;</p>
<p class="p1"><span class="Apple-converted-space">            </span>flex-shrink: 0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>.metro-arc {</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute; bottom: 10px; left: 50%; margin-left: -140px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 280px; height: 280px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-top: 1px solid #333; border-radius: 50%; opacity: 0.5;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* Targets */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.target-line {</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute; top: 50px; width: 4px; height: 60px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: #555; border-radius: 2px; z-index: 4;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.target-l { left: 12%; transform: rotate(15deg); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.target-r { right: 12%; transform: rotate(-15deg); }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* Bumpers */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bumper {</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute; top: 60px; width: 10px; height: 40px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: #333; border: 1px solid #555; border-radius: 4px; z-index: 5;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bumper-l { left: 10%; transform: rotate(15deg); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bumper-r { right: 10%; transform: rotate(-15deg); }</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* Flash */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bumper-flash {</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute; top: 40px; width: 60px; height: 80px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: radial-gradient(circle, #fff 0%, transparent 70%);</p>
<p class="p1"><span class="Apple-converted-space">            </span>opacity: 0; pointer-events: none; mix-blend-mode: screen; z-index: 20;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.flash-l { left: 5%; } .flash-r { right: 5%; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.hit-impact { animation: flashAnim 0.15s ease-out; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>@keyframes flashAnim { 0% { opacity: 1; transform: scale(1.5); } 100% { opacity: 0; transform: scale(1); } }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* Pendulum */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.pendulum-pivot {</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 16px; height: 16px; background: #222; border: 2px solid #444; border-radius: 50%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute; bottom: -8px; left: 50%; margin-left: -8px; z-index: 10;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.pendulum-rod {</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 4px; height: 200px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: linear-gradient(90deg, #444, #888, #444);</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute; bottom: 0; left: 50%; margin-left: -2px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>transform-origin: bottom center;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>transform: rotate(40deg); /* Init at Right */</p>
<p class="p1"><span class="Apple-converted-space">            </span>will-change: transform; z-index: 8;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.pendulum-weight {</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 30px; height: 40px; background: linear-gradient(135deg, #333 0%, #111 100%);</p>
<p class="p1"><span class="Apple-converted-space">            </span>border: 2px solid var(--c-accent); border-radius: 4px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute; top: 20px; left: 50%; margin-left: -15px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>box-shadow: 0 0 10px rgba(0, 123, 255, 0.4); z-index: 9;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* UI COMMON */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.status-bar {</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 10px; background: #080808;</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex; flex-direction: column; align-items: center; gap: 5px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-bottom: 1px solid var(--c-border); flex-shrink: 0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.star-row { display: flex; gap: 15px; font-size: 1.5rem; color: #333; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.star.active { color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.8); transform: scale(1.2); transition: transform 0.2s; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.progress-track { width: 100%; height: 4px; background: #222; border-radius: 2px; overflow: hidden; margin-top: 5px;}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.progress-fill { width: 0%; height: 100%; background: var(--c-accent); transition: width 0.1s linear; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.status-msg {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>font-size: 0.75rem; color: var(--c-sub); height: 1.2em; margin-top: 2px; font-weight: bold; letter-spacing: 1px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>animation: fadeIn 0.5s;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.blink { animation: pulse 1.5s infinite; color: #00d2ff; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>@keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>.metrics-area { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; flex-shrink: 0; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.card {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: var(--c-panel); border: 1px solid var(--c-border); border-radius: 10px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex; flex-direction: column; justify-content: center; align-items: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 15px 0; position: relative; transition: background 0.1s;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.card-lbl { font-size: 0.65rem; color: var(--c-sub); position: absolute; top: 8px; letter-spacing: 1px; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.card-val { font-size: 2.4rem; font-weight: 800; line-height: 1; margin-top: 5px;}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.card-sub { font-size: 0.9rem; font-weight: bold; margin-top: 5px; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>.wave-area { padding: 0 10px 10px 10px; height: 60px; flex-shrink: 0; position: relative; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.canvas-wrapper {</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 100%; height: 100%; background: #000; border: 1px solid var(--c-border);</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-radius: 6px; overflow: hidden; position: relative;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>canvas { display: block; width: 100%; height: 100%; }</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>.input-led {</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute; top: 5px; right: 15px; width: 12px; height: 12px; border-radius: 50%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: #222; border: 1px solid #444; transition: background 0.05s; z-index: 10;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.input-led.on { background: #00d2ff; box-shadow: 0 0 10px #00d2ff; border-color: #fff; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.input-led.noise { background: #ff3b30; box-shadow: 0 0 10px #ff3b30; animation: pulse 0.2s infinite; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>.history-area { flex-grow: 1; overflow-y: auto; min-height: 0; border-top: 1px solid var(--c-border); background: #050505; position: relative; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.hist-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.hist-table th { text-align: left; padding: 8px; color: var(--c-sub); font-size: 0.65rem; position: sticky; top: 0; background: #111; z-index: 2; border-bottom: 1px solid var(--c-border); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.hist-table td { padding: 8px; border-bottom: 1px solid #1a1a1a; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.hist-new { background: rgba(0, 123, 255, 0.15); border-left: 3px solid var(--c-accent); animation: flashRow 0.5s; }</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>.controls-area { padding: 12px; background: #000; border-top: 1px solid var(--c-border); display: flex; gap: 12px; padding-bottom: calc(12px + env(safe-area-inset-bottom)); flex-shrink: 0; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bpm-box { background: #222; border-radius: 10px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bpm-input { background: transparent; border: none; color: #fff; width: 100%; text-align: center; font-size: 1.2rem; font-weight: bold; padding: 0; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bpm-lbl { font-size: 0.6rem; color: var(--c-sub); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn { flex: 1; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; padding: 12px; letter-spacing: 1px; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-start { background: var(--c-accent); color: white; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-stop { background: var(--c-bad); color: white; opacity: 0.3; pointer-events: none; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-stop.active { opacity: 1; pointer-events: auto; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>details { flex-shrink: 0; padding: 5px 10px; background: #080808; border-top: 1px solid #222; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>summary { color: #555; font-size: 0.65rem; text-align: center; padding: 5px; cursor: pointer; list-style: none; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.settings-wrap { padding-bottom: 5px; display: flex; flex-direction: column; gap: 8px; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.setting-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #ccc; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>input[type=range] { width: 120px; accent-color: var(--c-accent); }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>.overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 99; display: none; flex-direction: column; justify-content: center; align-items: center; animation: fadeIn 0.3s; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.overlay h2 { font-size: 2.5rem; color: var(--c-warn); margin-bottom: 10px; text-shadow: 0 0 20px rgba(255, 204, 0, 0.5); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.overlay p { color: #fff; margin-bottom: 30px; font-size: 0.9rem; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-restart { padding: 15px 40px; border-radius: 30px; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; background: #fff; color: #000; }</p>
<p class="p2"><span class="Apple-converted-space">       </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>.c-p { color: var(--c-good); } .c-g { color: var(--c-warn); } .c-b { color: var(--c-bad); } .c-poor { color: var(--c-poor); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bg-p { background: rgba(76, 217, 100, 0.2); border-color: var(--c-good); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bg-g { background: rgba(255, 204, 0, 0.2); border-color: var(--c-warn); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bg-b { background: rgba(255, 59, 48, 0.2); border-color: var(--c-bad); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bg-poor { background: rgba(153, 153, 153, 0.2); border-color: var(--c-poor); }</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/style&gt;</p>
<p class="p1">&lt;/head&gt;</p>
<p class="p1">&lt;body&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;div class="header"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;h1&gt;LEGATO TRAINER v38&lt;/h1&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;select id="grooveSelect" class="mode-select"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;option value="1"&gt;Groove 1 (1/4)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;option value="2"&gt;Groove 2 (1/8)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;option value="3"&gt;Groove 3 (1/8 Triplet)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;option value="4"&gt;Groove 4 (Dotted)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/select&gt;</p>
<p class="p1">&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;div class="metronome-area"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="metro-arc"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="target-line target-l"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="target-line target-r"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="bumper bumper-l"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="bumper bumper-r"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="flashL" class="bumper-flash flash-l"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="flashR" class="bumper-flash flash-r"&gt;&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="pendulum-pivot"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="pendulumRod" class="pendulum-rod"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="pendulum-weight"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1">&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;div class="status-bar"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="star-row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;span id="s1" class="star"&gt;★&lt;/span&gt;&lt;span id="s2" class="star"&gt;★&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;span id="s3" class="star"&gt;★&lt;/span&gt;&lt;span id="s4" class="star"&gt;★&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="progress-track"&gt;&lt;div id="progressBar" class="progress-fill"&gt;&lt;/div&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="statusMsg" class="status-msg"&gt;READY&lt;/div&gt;</p>
<p class="p1">&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;div class="metrics-area"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="cardTime" class="card"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;span class="card-lbl"&gt;TIMING&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="valTime" class="card-val"&gt;--&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="subTime" class="card-sub"&gt;READY&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="cardLegato" class="card"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;span class="card-lbl"&gt;LEGATO&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="valLegato" class="card-val"&gt;--&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="subLegato" class="card-sub"&gt;--&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1">&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;div class="wave-area"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="inputLed" class="input-led"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="canvas-wrapper"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;canvas id="scope"&gt;&lt;/canvas&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1">&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;div class="history-area"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;table class="hist-table"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;thead&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;tr&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;th style="width:30px"&gt;#&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;th&gt;JUDGE&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;th style="text-align:right"&gt;LEGATO&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;th style="text-align:right"&gt;DIFF&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/tr&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/thead&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;tbody id="histBody"&gt;&lt;/tbody&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/table&gt;</p>
<p class="p1">&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;details&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;summary&gt;SETTINGS ▼&lt;/summary&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="settings-wrap"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="setting-item"&gt;&lt;span&gt;Vol&lt;/span&gt; &lt;input type="range" id="inVol" min="0" max="100" value="50"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="setting-item"&gt;&lt;span&gt;Sens&lt;/span&gt; &lt;input type="range" id="inSens" min="1" max="50" value="20"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="setting-item"&gt;&lt;span&gt;Latency&lt;/span&gt; &lt;input type="range" id="inLat" min="0" max="300" value="100"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1">&lt;/details&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;div class="controls-area"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="bpm-box"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;input type="number" id="inBpm" class="bpm-input" value="90"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;span class="bpm-lbl"&gt;BPM&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;button id="btnStart" class="btn btn-start"&gt;START&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;button id="btnStop" class="btn btn-stop"&gt;STOP&lt;/button&gt;</p>
<p class="p1">&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;div id="overlay" class="overlay"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;h2&gt;CLEAR!&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;p&gt;Excellent Rhythm &amp; Control&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;button id="btnRestart" class="btn-restart"&gt;NEXT CHALLENGE&lt;/button&gt;</p>
<p class="p1">&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;script&gt;</p>
<p class="p1">const engine = {</p>
<p class="p1"><span class="Apple-converted-space">    </span>ctx: null, mic: null, analyser: null, gain: null,</p>
<p class="p1"><span class="Apple-converted-space">    </span>running: false,<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>gameActive: false,<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>bpm: 90, nextTime: 0,</p>
<p class="p1"><span class="Apple-converted-space">    </span>startTime: 0,<span class="Apple-converted-space"> </span></p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>patterns: { 1: [1.0], 2: [0.5, 0.5], 3: [0.666, 0.333], 4: [0.75, 0.25] },</p>
<p class="p1"><span class="Apple-converted-space">    </span>currentPattern: 1, pIndex: 0, beatCount: 0,</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>targetQueue: [], vol: 0.5,<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>thresh: 0.04,<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>latency: 0.100,</p>
<p class="p1"><span class="Apple-converted-space">    </span>noteOn: false, noteStart: 0, lastHitId: -1,</p>
<p class="p1"><span class="Apple-converted-space">    </span>cycleHits: [], stars: 0,</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>lastBeatIndex: -1,</p>
<p class="p1"><span class="Apple-converted-space">    </span>noiseWarningCounter: 0</p>
<p class="p1">};</p>
<p class="p2"><br></p>
<p class="p1">const ui = {</p>
<p class="p1"><span class="Apple-converted-space">    </span>start: document.getElementById('btnStart'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>stop: document.getElementById('btnStop'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>restart: document.getElementById('btnRestart'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>bpm: document.getElementById('inBpm'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>groove: document.getElementById('grooveSelect'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>canvas: document.getElementById('scope'),</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>pendulum: document.getElementById('pendulumRod'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>flashL: document.getElementById('flashL'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>flashR: document.getElementById('flashR'),</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>hist: document.getElementById('histBody'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>valTime: document.getElementById('valTime'), subTime: document.getElementById('subTime'), cardTime: document.getElementById('cardTime'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>valLeg: document.getElementById('valLegato'), subLeg: document.getElementById('subLegato'), cardLeg: document.getElementById('cardLegato'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>bar: document.getElementById('progressBar'), msg: document.getElementById('statusMsg'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>stars: [document.getElementById('s1'), document.getElementById('s2'), document.getElementById('s3'), document.getElementById('s4')],</p>
<p class="p1"><span class="Apple-converted-space">    </span>inputLed: document.getElementById('inputLed'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>inVol: document.getElementById('inVol'), inSens: document.getElementById('inSens'), inLat: document.getElementById('inLat'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>overlay: document.getElementById('overlay')</p>
<p class="p1">};</p>
<p class="p2"><br></p>
<p class="p1">async function initAudio() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>const AC = window.AudioContext || window.webkitAudioContext;</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.ctx = new AC();</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.gain = engine.ctx.createGain();</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.gain.connect(engine.ctx.destination);</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (engine.ctx.state === 'suspended') await engine.ctx.resume();</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>try {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const stream = await navigator.mediaDevices.getUserMedia({<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>audio: { echoCancellation: false, autoGainControl: false, noiseSuppression: false, latency: 0 }</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>engine.mic = engine.ctx.createMediaStreamSource(stream);</p>
<p class="p1"><span class="Apple-converted-space">        </span>engine.analyser = engine.ctx.createAnalyser();</p>
<p class="p1"><span class="Apple-converted-space">        </span>engine.analyser.fftSize = 1024;</p>
<p class="p1"><span class="Apple-converted-space">        </span>engine.mic.connect(engine.analyser);</p>
<p class="p1"><span class="Apple-converted-space">    </span>} catch(e) { alert("Microphone Access Denied"); return false; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>return true;</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function scheduler() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>while (engine.nextTime &lt; engine.ctx.currentTime + 0.1) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>scheduleNote(engine.nextTime);</p>
<p class="p1"><span class="Apple-converted-space">        </span>advanceNote();</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (engine.running) setTimeout(scheduler, 25);</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function scheduleNote(time) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>const osc = engine.ctx.createOscillator();</p>
<p class="p1"><span class="Apple-converted-space">    </span>const g = engine.ctx.createGain();</p>
<p class="p1"><span class="Apple-converted-space">    </span>const isDownbeat = (engine.beatCount % 4 === 0) &amp;&amp; (engine.pIndex === 0);</p>
<p class="p1"><span class="Apple-converted-space">    </span>osc.frequency.value = isDownbeat ? 1500 : (engine.pIndex === 0 ? 1000 : 600);</p>
<p class="p1"><span class="Apple-converted-space">    </span>g.gain.value = 1.0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>osc.connect(g); g.connect(engine.gain);</p>
<p class="p1"><span class="Apple-converted-space">    </span>osc.start(time); osc.stop(time + 0.04);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.targetQueue = engine.targetQueue.filter(t =&gt; t.time &gt; engine.ctx.currentTime - 1.0);</p>
<p class="p1"><span class="Apple-converted-space">    </span>const pattern = engine.patterns[engine.currentPattern];</p>
<p class="p1"><span class="Apple-converted-space">    </span>const dur = (60 / engine.bpm) * pattern[engine.pIndex];</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.targetQueue.push({ id: Date.now() + Math.random(), time: time, duration: dur, hit: false });</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function advanceNote() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>const pattern = engine.patterns[engine.currentPattern];</p>
<p class="p1"><span class="Apple-converted-space">    </span>const secondsPerBeat = 60.0 / engine.bpm;</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.nextTime += secondsPerBeat * pattern[engine.pIndex];</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.pIndex++;</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (engine.pIndex &gt;= pattern.length) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>engine.pIndex = 0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>engine.beatCount++;</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (engine.gameActive) updateGameProgress();</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function updateVisualizer(now) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>const beatDur = 60.0 / engine.bpm;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const timeElapsed = now - engine.startTime;</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (timeElapsed &lt; 0) return;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Cosine Wave: Cos(0)=1 (Right), Cos(PI)=-1 (Left)</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Period is 2 beats (Right -&gt; Left -&gt; Right)</p>
<p class="p1"><span class="Apple-converted-space">    </span>const rad = (timeElapsed * Math.PI) / beatDur;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const angle = Math.cos(rad) * 40;<span class="Apple-converted-space"> </span></p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.pendulum.style.transform = `rotate(${angle}deg)`;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Trigger Logic: Use Math.floor so it triggers exactly when integer beat changes</p>
<p class="p1"><span class="Apple-converted-space">    </span>// t=0.99 -&gt; 0 (No trigger). t=1.0 -&gt; 1 (Trigger Left)</p>
<p class="p1"><span class="Apple-converted-space">    </span>const currentBeat = Math.floor((timeElapsed + 0.05) / beatDur); // Small offset to match audio latency buffer</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>if (currentBeat &gt; engine.lastBeatIndex) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>engine.lastBeatIndex = currentBeat;</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Even beat (0, 2, 4) = RIGHT (Cos=1)</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Odd beat (1, 3, 5) = LEFT (Cos=-1)</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (currentBeat % 2 === 0) triggerImpact('R');</p>
<p class="p1"><span class="Apple-converted-space">        </span>else triggerImpact('L');</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function triggerImpact(side) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.flashL.classList.remove('hit-impact');</p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.flashR.classList.remove('hit-impact');</p>
<p class="p1"><span class="Apple-converted-space">    </span>void ui.flashL.offsetWidth;<span class="Apple-converted-space"> </span></p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>if (side === 'L') ui.flashL.classList.add('hit-impact');</p>
<p class="p1"><span class="Apple-converted-space">    </span>else ui.flashR.classList.add('hit-impact');</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function detectionLoop() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (!engine.running) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>ui.pendulum.style.transform = `rotate(40deg)`;</p>
<p class="p1"><span class="Apple-converted-space">        </span>return;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const now = engine.ctx.currentTime;</p>
<p class="p1"><span class="Apple-converted-space">    </span>updateVisualizer(now);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const data = new Uint8Array(engine.analyser.frequencyBinCount);</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.analyser.getByteTimeDomainData(data);</p>
<p class="p1"><span class="Apple-converted-space">    </span>let sum = 0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>for(let i=0; i&lt;data.length; i++) { const x = (data[i]-128)/128.0; sum += x*x; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>const rms = Math.sqrt(sum / data.length);</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>if (rms &gt; engine.thresh) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>ui.inputLed.classList.add('on');</p>
<p class="p1"><span class="Apple-converted-space">        </span>engine.noiseWarningCounter++;</p>
<p class="p1"><span class="Apple-converted-space">    </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">        </span>ui.inputLed.classList.remove('on');</p>
<p class="p1"><span class="Apple-converted-space">        </span>engine.noiseWarningCounter = 0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>if (engine.noiseWarningCounter &gt; 180) {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>ui.msg.innerText = "NOISE! (RESET SENS)";</p>
<p class="p1"><span class="Apple-converted-space">        </span>ui.msg.style.color = "#ff3b30";</p>
<p class="p1"><span class="Apple-converted-space">        </span>ui.inputLed.classList.add('noise');</p>
<p class="p1"><span class="Apple-converted-space">    </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">        </span>ui.inputLed.classList.remove('noise');</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>if (!engine.noteOn &amp;&amp; rms &gt; engine.thresh) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (now - engine.noteStart &gt; 0.05) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>engine.noteOn = true;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>engine.noteStart = now;<span class="Apple-converted-space"> </span></p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!engine.gameActive) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>engine.gameActive = true;</p>
<p class="p1"><span class="Apple-converted-space">                </span>ui.msg.innerText = "COLLECT 4 STARS";</p>
<p class="p1"><span class="Apple-converted-space">                </span>ui.msg.classList.remove('blink');</p>
<p class="p1"><span class="Apple-converted-space">                </span>ui.msg.style.color = "#888";</p>
<p class="p1"><span class="Apple-converted-space">                </span>engine.beatCount = 0;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>ui.bar.style.width = "0%";</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>processHit(now);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>if (engine.noteOn &amp;&amp; rms &lt; (engine.thresh * 0.6)) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>engine.noteOn = false;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>processRelease(now);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>drawScope(rms);</p>
<p class="p1"><span class="Apple-converted-space">    </span>requestAnimationFrame(detectionLoop);</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function processHit(inputTime) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (!engine.gameActive) return;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const correctedTime = inputTime - engine.latency;</p>
<p class="p1"><span class="Apple-converted-space">    </span>let bestTarget = null; let minDiff = Infinity;</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.targetQueue.forEach(t =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const diff = Math.abs(correctedTime - t.time);</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (diff &lt; minDiff &amp;&amp; !t.hit) { minDiff = diff; bestTarget = t; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>});</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>if (bestTarget &amp;&amp; minDiff &lt; 0.25) {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>bestTarget.hit = true;</p>
<p class="p1"><span class="Apple-converted-space">        </span>engine.lastHitId = bestTarget.id;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const diffMs = Math.round((correctedTime - bestTarget.time) * 1000);</p>
<p class="p1"><span class="Apple-converted-space">        </span>renderTiming(diffMs);</p>
<p class="p1"><span class="Apple-converted-space">        </span>bestTarget.actualStart = engine.noteStart;</p>
<p class="p1"><span class="Apple-converted-space">    </span>} else if (bestTarget &amp;&amp; minDiff &lt; 0.35) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>renderTiming(Math.round((correctedTime - bestTarget.time) * 1000), "POOR");</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function processRelease(releaseTime) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>const target = engine.targetQueue.find(t =&gt; t.id === engine.lastHitId);</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (target &amp;&amp; !target.processed) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const dur = releaseTime - target.actualStart;</p>
<p class="p1"><span class="Apple-converted-space">        </span>let pct = Math.round((dur / target.duration) * 100);</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(pct &gt; 100) pct = 100;</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(dur &lt; 0.03) return;<span class="Apple-converted-space"> </span></p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>target.processed = true;</p>
<p class="p1"><span class="Apple-converted-space">        </span>renderLegato(pct);</p>
<p class="p1"><span class="Apple-converted-space">        </span>engine.cycleHits.push({ timing: target.lastDiff, legato: pct });</p>
<p class="p1"><span class="Apple-converted-space">        </span>addHistory(target.lastJudge, pct, target.lastDiff);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function renderTiming(diff, forceJudge) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>const abs = Math.abs(diff);</p>
<p class="p1"><span class="Apple-converted-space">    </span>let judge = "LATE"; let cls = "bg-b"; let col = "c-b";</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (diff &lt; 0) judge = "EARLY";</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>if (forceJudge === "POOR") {</p>
<p class="p1"><span class="Apple-converted-space">        </span>judge = "POOR"; cls = "bg-poor"; col = "c-poor";</p>
<p class="p1"><span class="Apple-converted-space">    </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (abs &lt;= 45) { judge = "PERFECT"; cls = "bg-p"; col = "c-p"; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>else if (abs &lt;= 100) { judge = "GOOD"; cls = "bg-g"; col = "c-g"; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.valTime.innerText = (diff&gt;0?"+":"") + diff;</p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.subTime.innerText = judge; ui.subTime.className = "card-sub " + col;</p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.cardTime.className = "card " + cls;</p>
<p class="p1"><span class="Apple-converted-space">    </span>setTimeout(() =&gt; ui.cardTime.className = "card", 150);</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>const target = engine.targetQueue.find(t =&gt; t.id === engine.lastHitId);</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(target) { target.lastDiff = diff; target.lastJudge = judge; }</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function renderLegato(pct) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>let judge = "SHORT"; let cls = "bg-b"; let col = "c-b";</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (pct &gt;= 85) { judge = "EXCELLENT"; cls = "bg-p"; col = "c-p"; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>else if (pct &gt;= 60) { judge = "OK"; cls = "bg-g"; col = "c-g"; }</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.valLeg.innerText = pct + "%";</p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.subLeg.innerText = judge; ui.subLeg.className = "card-sub " + col;</p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.cardLeg.className = "card " + cls;</p>
<p class="p1"><span class="Apple-converted-space">    </span>setTimeout(() =&gt; ui.cardLeg.className = "card", 150);</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function addHistory(judge, legato, diff) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>const row = document.createElement('tr');</p>
<p class="p1"><span class="Apple-converted-space">    </span>row.className = "hist-new";</p>
<p class="p1"><span class="Apple-converted-space">    </span>let col = "c-b";</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(judge==="PERFECT") col = "c-p"; if(judge==="GOOD") col = "c-g";</p>
<p class="p1"><span class="Apple-converted-space">    </span>row.innerHTML = `&lt;td&gt;#&lt;/td&gt;&lt;td class="${col}" style="font-weight:bold"&gt;${judge}&lt;/td&gt;&lt;td style="text-align:right"&gt;${legato}%&lt;/td&gt;&lt;td style="text-align:right; font-family:monospace"&gt;${diff&gt;0?"+"+diff:diff}&lt;/td&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.hist.prepend(row);</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (ui.hist.children.length &gt; 30) ui.hist.lastChild.remove();</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function updateGameProgress() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>const cyclePos = engine.beatCount % 16;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const pct = (cyclePos / 16) * 100;</p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.bar.style.width = pct + "%";</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (cyclePos === 0 &amp;&amp; engine.beatCount &gt; 0) evaluateCycle();</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function evaluateCycle() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>const hits = engine.cycleHits.length;</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (hits &lt; 4) {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>ui.msg.innerText = "PLAY MORE NOTES!"; ui.msg.style.color = "#666";</p>
<p class="p1"><span class="Apple-converted-space">    </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const avgT = engine.cycleHits.reduce((a,b)=&gt;a+Math.abs(b.timing),0) / hits;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const avgL = engine.cycleHits.reduce((a,b)=&gt;a+b.legato,0) / hits;</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (avgT &lt;= 60 &amp;&amp; avgL &gt;= 75) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>engine.stars++; ui.msg.innerText = "GREAT! STAR GET!"; ui.msg.style.color = "#ffd700"; updateStars();</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">            </span>ui.msg.innerText = `TRY AGAIN (Avg: ${Math.round(avgT)}ms / ${Math.round(avgL)}%)`; ui.msg.style.color = "#ff3b30";</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.cycleHits = [];</p>
<p class="p1"><span class="Apple-converted-space">    </span>setTimeout(() =&gt; ui.bar.style.width = "0%", 500);</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function updateStars() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>for(let i=0; i&lt;4; i++) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(i &lt; engine.stars) ui.stars[i].classList.add('active');</p>
<p class="p1"><span class="Apple-converted-space">        </span>else ui.stars[i].classList.remove('active');</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(engine.stars &gt;= 4) finishGame();</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function finishGame() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.running = false; ui.stop.click(); ui.overlay.style.display = 'flex';</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function resetToReady() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.overlay.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.stars = 0; updateStars();</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.gameActive = false;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.beatCount = 0;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.bar.style.width = "0%";<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.msg.innerText = "LISTEN... PLAY TO START";<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.msg.style.color = "#00d2ff"; ui.msg.classList.add('blink');</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.hist.innerHTML = "";</p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.valTime.innerText = "--"; ui.subTime.innerText = "READY"; ui.subTime.className = "card-sub";</p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.valLeg.innerText = "--"; ui.subLeg.innerText = "--"; ui.subLeg.className = "card-sub";</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">const ctxScope = ui.canvas.getContext('2d');</p>
<p class="p1">const visualScale = 600;<span class="Apple-converted-space"> </span></p>
<p class="p2"><br></p>
<p class="p1">function drawScope(rms) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>const w = ui.canvas.width; const h = ui.canvas.height;</p>
<p class="p1"><span class="Apple-converted-space">    </span>ctxScope.fillStyle = '#000'; ctxScope.fillRect(0, 0, w, h);</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>const thY = h - (engine.thresh * visualScale);</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>ctxScope.strokeStyle = '#333'; ctxScope.beginPath(); ctxScope.moveTo(0, h/2); ctxScope.lineTo(w, h/2); ctxScope.stroke();</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>const safeThY = Math.max(0, thY);<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>ctxScope.strokeStyle = '#007bff'; ctxScope.lineWidth = 2; ctxScope.setLineDash([4,2]); ctxScope.beginPath();<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>ctxScope.moveTo(0, safeThY); ctxScope.lineTo(w, safeThY);<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>ctxScope.stroke(); ctxScope.setLineDash([]);</p>
<p class="p1"><span class="Apple-converted-space">    </span>ctxScope.lineWidth = 1;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const barH = Math.min(rms * visualScale, h);</p>
<p class="p1"><span class="Apple-converted-space">    </span>ctxScope.fillStyle = engine.noteOn ? '#4cd964' : '#333';</p>
<p class="p1"><span class="Apple-converted-space">    </span>ctxScope.fillRect(w/2 - 20, h - barH, 40, barH);</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">ui.start.addEventListener('click', async () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(engine.running) return;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const ready = await initAudio();</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(!ready) return;</p>
<p class="p1"><span class="Apple-converted-space">    </span>resetToReady();</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.running = true;</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.bpm = parseInt(ui.bpm.value);</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.currentPattern = parseInt(ui.groove.value);</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.pIndex = 0; engine.beatCount = 0;<span class="Apple-converted-space"> </span></p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// SYNC START:</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Note logic starts at nextTime. Visual logic aligns to startTime.</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.nextTime = engine.ctx.currentTime + 0.1;</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.startTime = engine.nextTime;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.cycleHits = []; engine.targetQueue = [];</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.thresh = ui.inSens.value / 500;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.noteOn = false;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.noteStart = 0;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.lastHitId = -1;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.lastBeatIndex = -1;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.start.style.display = 'none'; ui.stop.classList.add('active');</p>
<p class="p1"><span class="Apple-converted-space">    </span>scheduler(); detectionLoop();</p>
<p class="p1">});</p>
<p class="p2"><br></p>
<p class="p1">ui.stop.addEventListener('click', () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.running = false; clearTimeout(engine.timerID);</p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.start.style.display = 'block'; ui.stop.classList.remove('active');</p>
<p class="p1"><span class="Apple-converted-space">    </span>ui.msg.classList.remove('blink');</p>
<p class="p1">});</p>
<p class="p2"><br></p>
<p class="p1">ui.restart.addEventListener('click', resetToReady);</p>
<p class="p2"><br></p>
<p class="p1">ui.groove.addEventListener('change', () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.currentPattern = parseInt(ui.groove.value);</p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.pIndex = 0;<span class="Apple-converted-space"> </span></p>
<p class="p1">});</p>
<p class="p2"><br></p>
<p class="p1">ui.inVol.addEventListener('input', e =&gt; {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>let v = e.target.value / 100;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>if(v &lt;= 0) v = 0.0001;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>engine.vol = v;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>if(engine.gain) engine.gain.gain.value = engine.vol;<span class="Apple-converted-space"> </span></p>
<p class="p1">});</p>
<p class="p1">ui.inSens.addEventListener('input', e =&gt; engine.thresh = e.target.value / 500);</p>
<p class="p1">ui.inLat.addEventListener('input', e =&gt; engine.latency = e.target.value / 1000);</p>
<p class="p2"><br></p>
<p class="p1">function resize() { ui.canvas.width = ui.canvas.clientWidth; ui.canvas.height = ui.canvas.clientHeight; }</p>
<p class="p1">window.addEventListener('resize', resize); resize();</p>
<p class="p1">&lt;/script&gt;</p>
<p class="p1">&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>
