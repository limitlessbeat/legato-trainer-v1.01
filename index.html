<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Legato Trainer v38 - Label Fixed</title>
    <style>
        /* --- v38 STYLE --- */
        :root {
            --c-bg: #000000;
            --c-panel: #111111;
            --c-border: #333333;
            --c-text: #ffffff;
            --c-sub: #888888;
            --c-accent: #007bff;
            --c-good: #4cd964;
            --c-warn: #ffcc00;
            --c-bad: #ff3b30;
            --c-poor: #666;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: "SF Mono", "Roboto Mono", -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--c-bg);
            color: var(--c-text);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100dvh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* HEADER */
        .header {
            padding: 12px 15px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--c-border);
            flex-shrink: 0;
            z-index: 10; background: var(--c-bg);
        }
        h1 { margin: 0; font-size: 0.9rem; font-weight: 800; letter-spacing: 1px; color: #ccc; }
        .mode-select {
            background: #222; color: #fff; border: 1px solid #444;
            padding: 6px 10px; border-radius: 6px; font-size: 0.8rem; outline: none;
            font-weight: bold;
        }

        /* METRONOME AREA */
        .metronome-area {
            height: 220px; 
            background: radial-gradient(circle at center bottom, #1a1a1a, #000);
            border-bottom: 1px solid var(--c-border);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .metro-arc {
            position: absolute; bottom: 10px; left: 50%; margin-left: -140px;
            width: 280px; height: 280px;
            border-top: 1px solid #333; border-radius: 50%; opacity: 0.5;
        }
        
        /* Targets */
        .target-line {
            position: absolute; top: 50px; width: 4px; height: 60px;
            background: #555; border-radius: 2px; z-index: 4;
        }
        .target-l { left: 12%; transform: rotate(15deg); }
        .target-r { right: 12%; transform: rotate(-15deg); }

        /* Bumpers */
        .bumper {
            position: absolute; top: 60px; width: 10px; height: 40px;
            background: #333; border: 1px solid #555; border-radius: 4px; z-index: 5;
        }
        .bumper-l { left: 10%; transform: rotate(15deg); }
        .bumper-r { right: 10%; transform: rotate(-15deg); }
        
        /* Flash */
        .bumper-flash {
            position: absolute; top: 40px; width: 60px; height: 80px;
            background: radial-gradient(circle, #fff 0%, transparent 70%);
            opacity: 0; pointer-events: none; mix-blend-mode: screen; z-index: 20;
        }
        .flash-l { left: 5%; } .flash-r { right: 5%; }
        .hit-impact { animation: flashAnim 0.15s ease-out; }
        @keyframes flashAnim { 0% { opacity: 1; transform: scale(1.5); } 100% { opacity: 0; transform: scale(1); } }

        /* Pendulum */
        .pendulum-pivot {
            width: 16px; height: 16px; background: #222; border: 2px solid #444; border-radius: 50%;
            position: absolute; bottom: -8px; left: 50%; margin-left: -8px; z-index: 10;
        }
        .pendulum-rod {
            width: 4px; height: 200px;
            background: linear-gradient(90deg, #444, #888, #444);
            position: absolute; bottom: 0; left: 50%; margin-left: -2px;
            transform-origin: bottom center; 
            transform: rotate(40deg); /* Init at Right */
            will-change: transform; z-index: 8;
        }
        .pendulum-weight {
            width: 30px; height: 40px; background: linear-gradient(135deg, #333 0%, #111 100%);
            border: 2px solid var(--c-accent); border-radius: 4px;
            position: absolute; top: 20px; left: 50%; margin-left: -15px;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.4); z-index: 9;
        }

        /* UI COMMON */
        .status-bar {
            padding: 10px; background: #080808;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            border-bottom: 1px solid var(--c-border); flex-shrink: 0;
        }
        .star-row { display: flex; gap: 15px; font-size: 1.5rem; color: #333; }
        .star.active { color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.8); transform: scale(1.2); transition: transform 0.2s; }
        .progress-track { width: 100%; height: 4px; background: #222; border-radius: 2px; overflow: hidden; margin-top: 5px;}
        .progress-fill { width: 0%; height: 100%; background: var(--c-accent); transition: width 0.1s linear; }
        .status-msg { 
            font-size: 0.75rem; color: var(--c-sub); height: 1.2em; margin-top: 2px; font-weight: bold; letter-spacing: 1px;
            animation: fadeIn 0.5s;
        }
        .blink { animation: pulse 1.5s infinite; color: #00d2ff; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .metrics-area { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; flex-shrink: 0; }
        .card {
            background: var(--c-panel); border: 1px solid var(--c-border); border-radius: 10px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 15px 0; position: relative; transition: background 0.1s;
        }
        .card-lbl { font-size: 0.65rem; color: var(--c-sub); position: absolute; top: 8px; letter-spacing: 1px; }
        .card-val { font-size: 2.4rem; font-weight: 800; line-height: 1; margin-top: 5px;}
        .card-sub { font-size: 0.9rem; font-weight: bold; margin-top: 5px; }

        .wave-area { padding: 0 10px 10px 10px; height: 60px; flex-shrink: 0; position: relative; }
        .canvas-wrapper {
            width: 100%; height: 100%; background: #000; border: 1px solid var(--c-border);
            border-radius: 6px; overflow: hidden; position: relative;
        }
        canvas { display: block; width: 100%; height: 100%; }
        
        .input-led {
            position: absolute; top: 5px; right: 15px; width: 12px; height: 12px; border-radius: 50%;
            background: #222; border: 1px solid #444; transition: background 0.05s; z-index: 10;
        }
        .input-led.on { background: #00d2ff; box-shadow: 0 0 10px #00d2ff; border-color: #fff; }
        .input-led.noise { background: #ff3b30; box-shadow: 0 0 10px #ff3b30; animation: pulse 0.2s infinite; }

        .history-area { flex-grow: 1; overflow-y: auto; min-height: 0; border-top: 1px solid var(--c-border); background: #050505; position: relative; }
        .hist-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .hist-table th { text-align: left; padding: 8px; color: var(--c-sub); font-size: 0.65rem; position: sticky; top: 0; background: #111; z-index: 2; border-bottom: 1px solid var(--c-border); }
        .hist-table td { padding: 8px; border-bottom: 1px solid #1a1a1a; }
        .hist-new { background: rgba(0, 123, 255, 0.15); border-left: 3px solid var(--c-accent); animation: flashRow 0.5s; }
        
        .controls-area { padding: 12px; background: #000; border-top: 1px solid var(--c-border); display: flex; gap: 12px; padding-bottom: calc(12px + env(safe-area-inset-bottom)); flex-shrink: 0; }
        .bpm-box { background: #222; border-radius: 10px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .bpm-input { background: transparent; border: none; color: #fff; width: 100%; text-align: center; font-size: 1.2rem; font-weight: bold; padding: 0; }
        .bpm-lbl { font-size: 0.6rem; color: var(--c-sub); }
        .btn { flex: 1; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; padding: 12px; letter-spacing: 1px; }
        .btn-start { background: var(--c-accent); color: white; }
        .btn-stop { background: var(--c-bad); color: white; opacity: 0.3; pointer-events: none; }
        .btn-stop.active { opacity: 1; pointer-events: auto; }

        details { flex-shrink: 0; padding: 5px 10px; background: #080808; border-top: 1px solid #222; }
        summary { color: #555; font-size: 0.65rem; text-align: center; padding: 5px; cursor: pointer; list-style: none; }
        .settings-wrap { padding-bottom: 5px; display: flex; flex-direction: column; gap: 8px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #ccc; }
        input[type=range] { width: 120px; accent-color: var(--c-accent); }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 99; display: none; flex-direction: column; justify-content: center; align-items: center; animation: fadeIn 0.3s; }
        .overlay h2 { font-size: 2.5rem; color: var(--c-warn); margin-bottom: 10px; text-shadow: 0 0 20px rgba(255, 204, 0, 0.5); }
        .overlay p { color: #fff; margin-bottom: 30px; font-size: 0.9rem; }
        .btn-restart { padding: 15px 40px; border-radius: 30px; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; background: #fff; color: #000; }
       
        .c-p { color: var(--c-good); } .c-g { color: var(--c-warn); } .c-b { color: var(--c-bad); } .c-poor { color: var(--c-poor); }
        .bg-p { background: rgba(76, 217, 100, 0.2); border-color: var(--c-good); }
        .bg-g { background: rgba(255, 204, 0, 0.2); border-color: var(--c-warn); }
        .bg-b { background: rgba(255, 59, 48, 0.2); border-color: var(--c-bad); }
        .bg-poor { background: rgba(153, 153, 153, 0.2); border-color: var(--c-poor); }
    </style>
</head>
<body>

<div class="header">
    <h1>LEGATO TRAINER v38</h1>
    <select id="grooveSelect" class="mode-select">
        <option value="1">Groove 1 (1/4)</option>
        <option value="2">Groove 2 (1/8)</option>
        <option value="3">Groove 3 (1/8 Triplet)</option>
        <option value="4">Groove 4 (Dotted)</option>
    </select>
</div>

<div class="metronome-area">
    <div class="metro-arc"></div>
    <div class="target-line target-l"></div>
    <div class="target-line target-r"></div>
    <div class="bumper bumper-l"></div>
    <div class="bumper bumper-r"></div>
    <div id="flashL" class="bumper-flash flash-l"></div>
    <div id="flashR" class="bumper-flash flash-r"></div>
    
    <div class="pendulum-pivot"></div>
    <div id="pendulumRod" class="pendulum-rod">
        <div class="pendulum-weight"></div>
    </div>
</div>

<div class="status-bar">
    <div class="star-row">
        <span id="s1" class="star">★</span><span id="s2" class="star">★</span>
        <span id="s3" class="star">★</span><span id="s4" class="star">★</span>
    </div>
    <div class="progress-track"><div id="progressBar" class="progress-fill"></div></div>
    <div id="statusMsg" class="status-msg">READY</div>
</div>

<div class="metrics-area">
    <div id="cardTime" class="card">
        <span class="card-lbl">TIMING</span>
        <div id="valTime" class="card-val">--</div>
        <div id="subTime" class="card-sub">READY</div>
    </div>
    <div id="cardLegato" class="card">
        <span class="card-lbl">LEGATO</span>
        <div id="valLegato" class="card-val">--</div>
        <div id="subLegato" class="card-sub">--</div>
    </div>
</div>

<div class="wave-area">
    <div id="inputLed" class="input-led"></div>
    <div class="canvas-wrapper">
        <canvas id="scope"></canvas>
    </div>
</div>

<div class="history-area">
    <table class="hist-table">
        <thead>
            <tr>
                <th style="width:30px">#</th>
                <th>JUDGE</th>
                <th style="text-align:right">LEGATO</th>
                <th style="text-align:right">DIFF</th>
            </tr>
        </thead>
        <tbody id="histBody"></tbody>
    </table>
</div>

<details>
    <summary>SETTINGS ▼</summary>
    <div class="settings-wrap">
        <div class="setting-item"><span>Vol</span> <input type="range" id="inVol" min="0" max="100" value="50"></div>
        <div class="setting-item"><span>Sens</span> <input type="range" id="inSens" min="1" max="50" value="20"></div>
        <div class="setting-item"><span>Latency</span> <input type="range" id="inLat" min="0" max="300" value="100"></div>
    </div>
</details>

<div class="controls-area">
    <div class="bpm-box">
        <input type="number" id="inBpm" class="bpm-input" value="90">
        <span class="bpm-lbl">BPM</span>
    </div>
    <button id="btnStart" class="btn btn-start">START</button>
    <button id="btnStop" class="btn btn-stop">STOP</button>
</div>

<div id="overlay" class="overlay">
    <h2>CLEAR!</h2>
    <p>Excellent Rhythm & Control</p>
    <button id="btnRestart" class="btn-restart">NEXT CHALLENGE</button>
</div>

<script>
const engine = {
    ctx: null, mic: null, analyser: null, gain: null,
    running: false, 
    gameActive: false, 
    bpm: 90, nextTime: 0,
    startTime: 0, 
    
    patterns: { 1: [1.0], 2: [0.5, 0.5], 3: [0.666, 0.333], 4: [0.75, 0.25] },
    currentPattern: 1, pIndex: 0, beatCount: 0,
    
    targetQueue: [], vol: 0.5, 
    thresh: 0.04, 
    latency: 0.100,
    noteOn: false, noteStart: 0, lastHitId: -1,
    cycleHits: [], stars: 0,
    
    lastBeatIndex: -1,
    noiseWarningCounter: 0
};

const ui = {
    start: document.getElementById('btnStart'),
    stop: document.getElementById('btnStop'),
    restart: document.getElementById('btnRestart'),
    bpm: document.getElementById('inBpm'),
    groove: document.getElementById('grooveSelect'),
    canvas: document.getElementById('scope'),
    
    pendulum: document.getElementById('pendulumRod'),
    flashL: document.getElementById('flashL'),
    flashR: document.getElementById('flashR'),
    
    hist: document.getElementById('histBody'),
    valTime: document.getElementById('valTime'), subTime: document.getElementById('subTime'), cardTime: document.getElementById('cardTime'),
    valLeg: document.getElementById('valLegato'), subLeg: document.getElementById('subLegato'), cardLeg: document.getElementById('cardLegato'),
    bar: document.getElementById('progressBar'), msg: document.getElementById('statusMsg'),
    stars: [document.getElementById('s1'), document.getElementById('s2'), document.getElementById('s3'), document.getElementById('s4')],
    inputLed: document.getElementById('inputLed'),
    inVol: document.getElementById('inVol'), inSens: document.getElementById('inSens'), inLat: document.getElementById('inLat'),
    overlay: document.getElementById('overlay')
};

async function initAudio() {
    const AC = window.AudioContext || window.webkitAudioContext;
    engine.ctx = new AC();
    engine.gain = engine.ctx.createGain();
    engine.gain.connect(engine.ctx.destination);
    if (engine.ctx.state === 'suspended') await engine.ctx.resume();
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: { echoCancellation: false, autoGainControl: false, noiseSuppression: false, latency: 0 }
        });
        engine.mic = engine.ctx.createMediaStreamSource(stream);
        engine.analyser = engine.ctx.createAnalyser();
        engine.analyser.fftSize = 1024;
        engine.mic.connect(engine.analyser);
    } catch(e) { alert("Microphone Access Denied"); return false; }
    return true;
}

function scheduler() {
    while (engine.nextTime < engine.ctx.currentTime + 0.1) {
        scheduleNote(engine.nextTime);
        advanceNote();
    }
    if (engine.running) setTimeout(scheduler, 25);
}

function scheduleNote(time) {
    const osc = engine.ctx.createOscillator();
    const g = engine.ctx.createGain();
    const isDownbeat = (engine.beatCount % 4 === 0) && (engine.pIndex === 0);
    osc.frequency.value = isDownbeat ? 1500 : (engine.pIndex === 0 ? 1000 : 600);
    g.gain.value = 1.0;
    osc.connect(g); g.connect(engine.gain);
    osc.start(time); osc.stop(time + 0.04);

    engine.targetQueue = engine.targetQueue.filter(t => t.time > engine.ctx.currentTime - 1.0);
    const pattern = engine.patterns[engine.currentPattern];
    const dur = (60 / engine.bpm) * pattern[engine.pIndex];
    
    engine.targetQueue.push({ id: Date.now() + Math.random(), time: time, duration: dur, hit: false });
}

function advanceNote() {
    const pattern = engine.patterns[engine.currentPattern];
    const secondsPerBeat = 60.0 / engine.bpm;
    engine.nextTime += secondsPerBeat * pattern[engine.pIndex];
    engine.pIndex++;
    if (engine.pIndex >= pattern.length) {
        engine.pIndex = 0;
        engine.beatCount++;
        if (engine.gameActive) updateGameProgress();
    }
}

function updateVisualizer(now) {
    const beatDur = 60.0 / engine.bpm;
    const timeElapsed = now - engine.startTime;
    if (timeElapsed < 0) return;

    // Cosine Wave: Cos(0)=1 (Right), Cos(PI)=-1 (Left)
    // Period is 2 beats (Right -> Left -> Right)
    const rad = (timeElapsed * Math.PI) / beatDur;
    const angle = Math.cos(rad) * 40; 
    
    ui.pendulum.style.transform = `rotate(${angle}deg)`;
    
    // Trigger Logic: Use Math.floor so it triggers exactly when integer beat changes
    // t=0.99 -> 0 (No trigger). t=1.0 -> 1 (Trigger Left)
    const currentBeat = Math.floor((timeElapsed + 0.05) / beatDur); // Small offset to match audio latency buffer
    
    if (currentBeat > engine.lastBeatIndex) {
        engine.lastBeatIndex = currentBeat;
        // Even beat (0, 2, 4) = RIGHT (Cos=1)
        // Odd beat (1, 3, 5) = LEFT (Cos=-1)
        if (currentBeat % 2 === 0) triggerImpact('R');
        else triggerImpact('L');
    }
}

function triggerImpact(side) {
    ui.flashL.classList.remove('hit-impact');
    ui.flashR.classList.remove('hit-impact');
    void ui.flashL.offsetWidth; 
    
    if (side === 'L') ui.flashL.classList.add('hit-impact');
    else ui.flashR.classList.add('hit-impact');
}

function detectionLoop() {
    if (!engine.running) {
        ui.pendulum.style.transform = `rotate(40deg)`;
        return;
    }

    const now = engine.ctx.currentTime;
    updateVisualizer(now);

    const data = new Uint8Array(engine.analyser.frequencyBinCount);
    engine.analyser.getByteTimeDomainData(data);
    let sum = 0;
    for(let i=0; i<data.length; i++) { const x = (data[i]-128)/128.0; sum += x*x; }
    const rms = Math.sqrt(sum / data.length);
    
    if (rms > engine.thresh) {
        ui.inputLed.classList.add('on');
        engine.noiseWarningCounter++;
    } else {
        ui.inputLed.classList.remove('on');
        engine.noiseWarningCounter = 0;
    }

    if (engine.noiseWarningCounter > 180) { 
        ui.msg.innerText = "NOISE! (RESET SENS)";
        ui.msg.style.color = "#ff3b30";
        ui.inputLed.classList.add('noise');
    } else {
        ui.inputLed.classList.remove('noise');
    }

    if (!engine.noteOn && rms > engine.thresh) {
        if (now - engine.noteStart > 0.05) {
            engine.noteOn = true; 
            engine.noteStart = now; 
            
            if (!engine.gameActive) {
                engine.gameActive = true;
                ui.msg.innerText = "COLLECT 4 STARS";
                ui.msg.classList.remove('blink');
                ui.msg.style.color = "#888";
                engine.beatCount = 0; 
                ui.bar.style.width = "0%";
            }
            processHit(now);
        }
    }
    
    if (engine.noteOn && rms < (engine.thresh * 0.6)) {
        engine.noteOn = false; 
        processRelease(now);
    }
    
    drawScope(rms);
    requestAnimationFrame(detectionLoop);
}

function processHit(inputTime) {
    if (!engine.gameActive) return;

    const correctedTime = inputTime - engine.latency;
    let bestTarget = null; let minDiff = Infinity;
    engine.targetQueue.forEach(t => {
        const diff = Math.abs(correctedTime - t.time);
        if (diff < minDiff && !t.hit) { minDiff = diff; bestTarget = t; }
    });
    
    if (bestTarget && minDiff < 0.25) { 
        bestTarget.hit = true;
        engine.lastHitId = bestTarget.id;
        const diffMs = Math.round((correctedTime - bestTarget.time) * 1000);
        renderTiming(diffMs);
        bestTarget.actualStart = engine.noteStart;
    } else if (bestTarget && minDiff < 0.35) {
        renderTiming(Math.round((correctedTime - bestTarget.time) * 1000), "POOR");
    }
}

function processRelease(releaseTime) {
    const target = engine.targetQueue.find(t => t.id === engine.lastHitId);
    if (target && !target.processed) {
        const dur = releaseTime - target.actualStart;
        let pct = Math.round((dur / target.duration) * 100);
        if(pct > 100) pct = 100;
        if(dur < 0.03) return; 
        
        target.processed = true;
        renderLegato(pct);
        engine.cycleHits.push({ timing: target.lastDiff, legato: pct });
        addHistory(target.lastJudge, pct, target.lastDiff);
    }
}

function renderTiming(diff, forceJudge) {
    const abs = Math.abs(diff);
    let judge = "LATE"; let cls = "bg-b"; let col = "c-b";
    if (diff < 0) judge = "EARLY";
    
    if (forceJudge === "POOR") {
        judge = "POOR"; cls = "bg-poor"; col = "c-poor";
    } else {
        if (abs <= 45) { judge = "PERFECT"; cls = "bg-p"; col = "c-p"; }
        else if (abs <= 100) { judge = "GOOD"; cls = "bg-g"; col = "c-g"; }
    }
    
    ui.valTime.innerText = (diff>0?"+":"") + diff;
    ui.subTime.innerText = judge; ui.subTime.className = "card-sub " + col;
    ui.cardTime.className = "card " + cls;
    setTimeout(() => ui.cardTime.className = "card", 150);
    
    const target = engine.targetQueue.find(t => t.id === engine.lastHitId);
    if(target) { target.lastDiff = diff; target.lastJudge = judge; }
}

function renderLegato(pct) {
    let judge = "SHORT"; let cls = "bg-b"; let col = "c-b";
    if (pct >= 85) { judge = "EXCELLENT"; cls = "bg-p"; col = "c-p"; }
    else if (pct >= 60) { judge = "OK"; cls = "bg-g"; col = "c-g"; }
    
    ui.valLeg.innerText = pct + "%";
    ui.subLeg.innerText = judge; ui.subLeg.className = "card-sub " + col;
    ui.cardLeg.className = "card " + cls;
    setTimeout(() => ui.cardLeg.className = "card", 150);
}

function addHistory(judge, legato, diff) {
    const row = document.createElement('tr');
    row.className = "hist-new";
    let col = "c-b";
    if(judge==="PERFECT") col = "c-p"; if(judge==="GOOD") col = "c-g";
    row.innerHTML = `<td>#</td><td class="${col}" style="font-weight:bold">${judge}</td><td style="text-align:right">${legato}%</td><td style="text-align:right; font-family:monospace">${diff>0?"+"+diff:diff}</td>`;
    ui.hist.prepend(row);
    if (ui.hist.children.length > 30) ui.hist.lastChild.remove();
}

function updateGameProgress() {
    const cyclePos = engine.beatCount % 16;
    const pct = (cyclePos / 16) * 100;
    ui.bar.style.width = pct + "%";
    if (cyclePos === 0 && engine.beatCount > 0) evaluateCycle();
}

function evaluateCycle() {
    const hits = engine.cycleHits.length;
    if (hits < 4) { 
        ui.msg.innerText = "PLAY MORE NOTES!"; ui.msg.style.color = "#666";
    } else {
        const avgT = engine.cycleHits.reduce((a,b)=>a+Math.abs(b.timing),0) / hits;
        const avgL = engine.cycleHits.reduce((a,b)=>a+b.legato,0) / hits;
        if (avgT <= 60 && avgL >= 75) {
            engine.stars++; ui.msg.innerText = "GREAT! STAR GET!"; ui.msg.style.color = "#ffd700"; updateStars();
        } else {
            ui.msg.innerText = `TRY AGAIN (Avg: ${Math.round(avgT)}ms / ${Math.round(avgL)}%)`; ui.msg.style.color = "#ff3b30";
        }
    }
    engine.cycleHits = [];
    setTimeout(() => ui.bar.style.width = "0%", 500);
}

function updateStars() {
    for(let i=0; i<4; i++) {
        if(i < engine.stars) ui.stars[i].classList.add('active');
        else ui.stars[i].classList.remove('active');
    }
    if(engine.stars >= 4) finishGame();
}

function finishGame() {
    engine.running = false; ui.stop.click(); ui.overlay.style.display = 'flex';
}

function resetToReady() {
    ui.overlay.style.display = 'none';
    engine.stars = 0; updateStars();
    engine.gameActive = false; 
    engine.beatCount = 0;
    
    ui.bar.style.width = "0%"; 
    ui.msg.innerText = "LISTEN... PLAY TO START"; 
    ui.msg.style.color = "#00d2ff"; ui.msg.classList.add('blink');
    
    ui.hist.innerHTML = "";
    ui.valTime.innerText = "--"; ui.subTime.innerText = "READY"; ui.subTime.className = "card-sub";
    ui.valLeg.innerText = "--"; ui.subLeg.innerText = "--"; ui.subLeg.className = "card-sub";
}

const ctxScope = ui.canvas.getContext('2d');
const visualScale = 600; 

function drawScope(rms) {
    const w = ui.canvas.width; const h = ui.canvas.height;
    ctxScope.fillStyle = '#000'; ctxScope.fillRect(0, 0, w, h);
    
    const thY = h - (engine.thresh * visualScale);
    
    ctxScope.strokeStyle = '#333'; ctxScope.beginPath(); ctxScope.moveTo(0, h/2); ctxScope.lineTo(w, h/2); ctxScope.stroke();
    
    const safeThY = Math.max(0, thY); 
    ctxScope.strokeStyle = '#007bff'; ctxScope.lineWidth = 2; ctxScope.setLineDash([4,2]); ctxScope.beginPath(); 
    ctxScope.moveTo(0, safeThY); ctxScope.lineTo(w, safeThY); 
    ctxScope.stroke(); ctxScope.setLineDash([]);
    ctxScope.lineWidth = 1;

    const barH = Math.min(rms * visualScale, h);
    ctxScope.fillStyle = engine.noteOn ? '#4cd964' : '#333';
    ctxScope.fillRect(w/2 - 20, h - barH, 40, barH);
}

ui.start.addEventListener('click', async () => {
    if(engine.running) return;
    const ready = await initAudio();
    if(!ready) return;
    resetToReady();
    
    engine.running = true;
    engine.bpm = parseInt(ui.bpm.value);
    engine.currentPattern = parseInt(ui.groove.value);
    engine.pIndex = 0; engine.beatCount = 0; 
    
    // SYNC START:
    // Note logic starts at nextTime. Visual logic aligns to startTime.
    engine.nextTime = engine.ctx.currentTime + 0.1;
    engine.startTime = engine.nextTime;
    
    engine.cycleHits = []; engine.targetQueue = [];
    engine.thresh = ui.inSens.value / 500;
    
    engine.noteOn = false; 
    engine.noteStart = 0; 
    engine.lastHitId = -1; 
    engine.lastBeatIndex = -1;
    
    ui.start.style.display = 'none'; ui.stop.classList.add('active');
    scheduler(); detectionLoop();
});

ui.stop.addEventListener('click', () => {
    engine.running = false; clearTimeout(engine.timerID);
    ui.start.style.display = 'block'; ui.stop.classList.remove('active');
    ui.msg.classList.remove('blink');
});

ui.restart.addEventListener('click', resetToReady);

ui.groove.addEventListener('change', () => {
    engine.currentPattern = parseInt(ui.groove.value);
    engine.pIndex = 0; 
});

ui.inVol.addEventListener('input', e => { 
    let v = e.target.value / 100; 
    if(v <= 0) v = 0.0001; 
    engine.vol = v; 
    if(engine.gain) engine.gain.gain.value = engine.vol; 
});
ui.inSens.addEventListener('input', e => engine.thresh = e.target.value / 500);
ui.inLat.addEventListener('input', e => engine.latency = e.target.value / 1000);

function resize() { ui.canvas.width = ui.canvas.clientWidth; ui.canvas.height = ui.canvas.clientHeight; }
window.addEventListener('resize', resize); resize();
</script>
</body>
</html>
