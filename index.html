<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Legato Trainer v62 - iOS Calibration Fix</title>
    <style>
        /* --- v62 STYLE --- */
        :root {
            --c-bg: #000000;
            --c-panel: #111111;
            --c-border: #333333;
            --c-text: #ffffff;
            --c-sub: #888888;
            --c-accent: #007bff;
            --c-good: #4cd964;
            --c-warn: #ffcc00;
            --c-bad: #ff3b30;
            --c-poor: #666;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: "SF Mono", "Roboto Mono", -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--c-bg);
            color: var(--c-text);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100dvh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* HEADER */
        .header {
            padding: calc(5px + env(safe-area-inset-top)) 10px 5px 10px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--c-border);
            flex-shrink: 0;
            z-index: 10; background: var(--c-bg);
            height: 40px;
        }
        h1 { margin: 0; font-size: 0.7rem; font-weight: 800; letter-spacing: 1px; color: #ccc; }
        .mode-select {
            background: #222; color: #fff; border: 1px solid #444;
            padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; outline: none;
            font-weight: bold;
        }

        /* METRONOME AREA */
        .metronome-area {
            flex-shrink: 0;
            height: 70px;
            background: radial-gradient(circle at center bottom, #1a1a1a, #000);
            border-bottom: 1px solid var(--c-border);
            position: relative;
            overflow: hidden;
        }
        
        .metro-arc {
            position: absolute; bottom: -40px; left: 50%; margin-left: -100px;
            width: 200px; height: 200px;
            border-top: 1px solid #333; border-radius: 50%; opacity: 0.5;
        }
        
        .bumper {
            position: absolute; top: 20px; width: 6px; height: 25px;
            background: #333; border: 1px solid #555; border-radius: 2px; z-index: 5;
        }
        .bumper-l { left: 25%; transform: rotate(15deg); }
        .bumper-r { right: 25%; transform: rotate(-15deg); }
        
        .bumper-flash {
            position: absolute; top: 10px; width: 30px; height: 40px;
            background: radial-gradient(circle, #fff 0%, transparent 70%);
            opacity: 0; pointer-events: none; mix-blend-mode: screen; z-index: 20;
        }
        .flash-l { left: 20%; } .flash-r { right: 20%; }
        .hit-impact { animation: flashAnim 0.15s ease-out; }
        @keyframes flashAnim { 0% { opacity: 1; transform: scale(1.5); } 100% { opacity: 0; transform: scale(1); } }

        .pendulum-pivot {
            width: 10px; height: 10px; background: #222; border: 2px solid #444; border-radius: 50%;
            position: absolute; bottom: -5px; left: 50%; margin-left: -5px; z-index: 10;
        }
        .pendulum-rod {
            width: 3px; height: 65px;
            background: linear-gradient(90deg, #444, #888, #444);
            position: absolute; bottom: 0; left: 50%; margin-left: -1.5px;
            transform-origin: bottom center; transform: rotate(40deg);
            will-change: transform; z-index: 8;
        }
        .pendulum-weight {
            width: 18px; height: 24px; background: linear-gradient(135deg, #333 0%, #111 100%);
            border: 2px solid var(--c-accent); border-radius: 4px;
            position: absolute; top: 10px; left: 50%; margin-left: -9px;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.4); z-index: 9;
        }

        /* STATUS */
        .status-bar {
            padding: 4px; background: #080808;
            display: flex; flex-direction: column; align-items: center; gap: 2px;
            border-bottom: 1px solid var(--c-border); flex-shrink: 0;
        }
        .star-row { display: flex; gap: 8px; font-size: 1.0rem; color: #333; }
        .star.active { color: #ffd700; text-shadow: 0 0 8px rgba(255, 215, 0, 0.8); transform: scale(1.1); transition: transform 0.2s; }
        .progress-track { width: 100%; height: 3px; background: #222; border-radius: 2px; overflow: hidden; margin-top: 2px;}
        .progress-fill { width: 0%; height: 100%; background: var(--c-accent); transition: width 0.1s linear; }
        .status-msg { 
            font-size: 0.65rem; color: var(--c-sub); height: 1.1em; margin-top: 1px; font-weight: bold; letter-spacing: 1px;
            animation: fadeIn 0.5s;
        }
        .blink { animation: pulse 1.5s infinite; color: #00d2ff; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* METRICS */
        .metrics-area {
            display: grid; grid-template-columns: 1fr 1.3fr;
            gap: 4px; padding: 4px; flex-shrink: 0;
        }
        .card {
            background: var(--c-panel); border: 1px solid var(--c-border); border-radius: 6px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 6px 0; position: relative; transition: background 0.1s;
        }
        .card-lbl { font-size: 0.5rem; color: var(--c-sub); position: absolute; top: 4px; letter-spacing: 1px; }
        
        #cardTime .card-val { font-size: 1.2rem; font-weight: bold; line-height: 1; margin-top: 8px; color: #ccc; }
        #cardTime .card-sub { font-size: 0.6rem; font-weight: bold; margin-top: 2px; }

        #cardLegato .card-val { font-size: 2.2rem; font-weight: 800; line-height: 1; margin-top: 6px; color: #fff; }
        #cardLegato .card-sub { font-size: 0.8rem; font-weight: bold; margin-top: 2px; }

        /* WAVE */
        .wave-area { padding: 0 4px 4px 4px; height: 20px; flex-shrink: 0; position: relative; }
        .canvas-wrapper {
            width: 100%; height: 100%; background: #000; border: 1px solid var(--c-border);
            border-radius: 4px; overflow: hidden; position: relative;
        }
        canvas { display: block; width: 100%; height: 100%; }
        .input-led {
            position: absolute; top: 2px; right: 6px; width: 6px; height: 6px; border-radius: 50%;
            background: #222; border: 1px solid #444; transition: background 0.05s; z-index: 10;
        }
        .input-led.on { background: #00d2ff; box-shadow: 0 0 6px #00d2ff; border-color: #fff; }
        .input-led.noise { background: #ff3b30; box-shadow: 0 0 6px #ff3b30; animation: pulse 0.2s infinite; }

        /* HISTORY */
        .history-area {
            flex: 1; 
            overflow-y: scroll; 
            -webkit-overflow-scrolling: touch;
            border-top: 1px solid var(--c-border); background: #050505; position: relative;
            margin: 0;
        }
        .hist-table { 
            width: 100%; border-collapse: collapse; font-size: 0.65rem; 
            table-layout: fixed;
        }
        .hist-table th { 
            text-align: left; padding: 4px 6px; color: var(--c-sub); font-size: 0.5rem; 
            position: sticky; top: 0; background: #111; z-index: 2; border-bottom: 1px solid var(--c-border);
        }
        .hist-table td { 
            padding: 4px 6px; border-bottom: 1px solid #1a1a1a; vertical-align: middle;
            height: 28px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .hist-new { background: rgba(0, 123, 255, 0.15); border-left: 3px solid var(--c-accent); animation: flashRow 0.5s; }
        
        .col-idx { width: 25px; color: #555; text-align: center; }
        .col-tim { width: 25%; text-align: left; color: #888; font-size: 0.6rem; }
        .col-dif { width: 15%; text-align: right; font-family: monospace; color: #666; }
        .col-leg { width: 25%; font-weight: 800; font-size: 0.7rem; text-align: right;}
        .col-scr { width: 15%; font-weight: bold; text-align: right; }

        /* SETTINGS */
        details { flex-shrink: 0; padding: 2px 10px; background: #080808; border-top: 1px solid #222; }
        summary { color: #555; font-size: 0.6rem; text-align: center; padding: 4px; cursor: pointer; list-style: none; }
        .settings-wrap { padding-bottom: 4px; display: flex; flex-direction: column; gap: 4px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; color: #ccc; }
        input[type=range] { width: 120px; accent-color: var(--c-accent); }
        
        .btn-mini {
            padding: 4px 10px; border-radius: 15px; border: 1px solid #555;
            background: #333; color: #fff; font-size: 0.6rem; font-weight: bold;
            cursor: pointer;
        }

        /* CONTROLS */
        .controls-area {
            background: #000; border-top: 1px solid var(--c-border);
            display: flex; gap: 8px; 
            padding: 8px 8px calc(28px + env(safe-area-inset-bottom)) 8px;
            flex-shrink: 0;
            position: relative;
        }
        .bpm-box { background: #222; border-radius: 8px; width: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .bpm-input { background: transparent; border: none; color: #fff; width: 100%; text-align: center; font-size: 1.0rem; font-weight: bold; padding: 0; }
        .bpm-lbl { font-size: 0.5rem; color: var(--c-sub); }
        .btn { 
            flex: 1; border: none; outline: none; box-shadow: none;
            border-radius: 8px; font-size: 1.0rem; font-weight: bold; 
            cursor: pointer; padding: 10px; letter-spacing: 1px; 
        }
        .btn-start { background: var(--c-accent); color: white; }
        .btn-stop { background: var(--c-bad); color: white; opacity: 0.3; pointer-events: none; }
        .btn-stop.active { opacity: 1; pointer-events: auto; }

        .credit {
            position: absolute;
            bottom: calc(4px + env(safe-area-inset-bottom));
            left: 0; width: 100%;
            text-align: center;
            font-size: 0.5rem;
            line-height: 1.3;
            color: #444;
            pointer-events: none;
            z-index: 20;
            font-weight: bold;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* OVERLAY */
        .overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.98); z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            animation: fadeIn 0.3s;
            cursor: pointer;
        }
        .overlay h2 { font-size: 2.0rem; color: var(--c-warn); margin-bottom: 15px; text-align: center; }
        .overlay p { color: #ccc; margin-bottom: 30px; font-size: 0.8rem; text-align: center; line-height: 1.5; max-width: 80%; }
        
        .btn-calib-start {
            padding: 20px 40px; border-radius: 40px; border: none;
            font-size: 1.2rem; font-weight: 800; cursor: pointer;
            background: var(--c-good); color: #000;
            box-shadow: 0 0 25px rgba(76, 217, 100, 0.6);
            margin-bottom: 20px;
        }
        .btn-calib-start:disabled { opacity: 0.5; cursor: wait; }

        .btn-restart { 
            padding: 15px 40px; border-radius: 30px; border: none; 
            font-size: 1.2rem; font-weight: bold; cursor: pointer; 
            background: var(--c-accent); color: #fff; 
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.5);
        }
        
        .calib-progress { font-size: 3rem; font-weight: 800; color: #fff; margin-top: 20px; min-height: 40px; }
        .skip-link { margin-top: 20px; color: #666; font-size: 0.7rem; text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <h1>LEGATO TRAINER v62</h1>
    <select id="grooveSelect" class="mode-select">
        <option value="1">Groove 1 (1/4)</option>
        <option value="2">Groove 2 (1/8)</option>
        <option value="3">Groove 3 (1/8 Triplet)</option>
        <option value="4">Groove 4 (Dotted)</option>
    </select>
</div>

<div class="metronome-area">
    <div class="metro-arc"></div>
    <div class="bumper bumper-l"></div>
    <div class="bumper bumper-r"></div>
    <div id="flashL" class="bumper-flash flash-l"></div>
    <div id="flashR" class="bumper-flash flash-r"></div>
    
    <div class="pendulum-pivot"></div>
    <div id="pendulumRod" class="pendulum-rod">
        <div class="pendulum-weight"></div>
    </div>
</div>

<div class="status-bar">
    <div class="star-row">
        <span id="s1" class="star">★</span><span id="s2" class="star">★</span>
        <span id="s3" class="star">★</span><span id="s4" class="star">★</span>
    </div>
    <div class="progress-track"><div id="progressBar" class="progress-fill"></div></div>
    <div id="statusMsg" class="status-msg">READY</div>
</div>

<div class="metrics-area">
    <div id="cardTime" class="card">
        <span class="card-lbl">TIMING</span>
        <div id="valTime" class="card-val">--</div>
        <div id="subTime" class="card-sub">READY</div>
    </div>
    <div id="cardLegato" class="card">
        <span class="card-lbl">LEGATO</span>
        <div id="valLegato" class="card-val">--</div>
        <div id="subLegato" class="card-sub">--</div>
    </div>
</div>

<div class="wave-area">
    <div id="inputLed" class="input-led"></div>
    <div class="canvas-wrapper">
        <canvas id="scope"></canvas>
    </div>
</div>

<div class="history-area">
    <table class="hist-table">
        <thead>
            <tr>
                <th class="col-idx">#</th>
                <th class="col-tim">TIMING</th>
                <th class="col-dif">DIFF</th>
                <th class="col-leg">LEGATO</th>
                <th class="col-scr">SCORE</th>
            </tr>
        </thead>
        <tbody id="histBody"></tbody>
    </table>
</div>

<details>
    <summary>SETTINGS ▼</summary>
    <div class="settings-wrap">
        <div class="setting-item"><span>Auto Calib</span> <button id="btnReCalib" class="btn-mini">RUN</button></div>
        <div class="setting-item"><span>Vol</span> <input type="range" id="inVol" min="0" max="100" value="50"></div>
        <div class="setting-item"><span>Sens</span> <input type="range" id="inSens" min="1" max="50" value="6"></div>
        <div class="setting-item"><span>Latency</span> <input type="range" id="inLat" min="0" max="300" value="240"></div>
    </div>
</details>

<div class="controls-area">
    <div class="bpm-box">
        <input type="number" id="inBpm" class="bpm-input" value="90">
        <span class="bpm-lbl">BPM</span>
    </div>
    <button id="btnStart" class="btn btn-start">START</button>
    <button id="btnStop" class="btn btn-stop">STOP</button>
    
    <div class="credit">
        Takeshi Ohbayashi presents<br>
        <span style="font-weight:normal; opacity:0.7">created by DONGURI Music & Arts</span>
    </div>
</div>

<div id="overlay" class="overlay" style="display:flex">
    <h2 id="ovTitle">SETUP</h2>
    <p id="ovDesc">Set volume MAX & unmute.<br>Tap button to calibrate.</p>
    
    <button id="btnCalibStart" class="btn-calib-start">TAP TO START</button>
    <div id="calibCount" class="calib-progress"></div>
    
    <button id="btnRestart" class="btn-restart" style="display:none">CONTINUE</button>
    <div id="skipLink" class="skip-link">SKIP CALIBRATION</div>
</div>

<script>
const engine = {
    ctx: null, mic: null, analyser: null, gain: null,
    running: false, 
    gameActive: false, 
    bpm: 90, nextTime: 0,
    startTime: 0, 
    
    patterns: { 1: [1.0], 2: [0.5, 0.5], 3: [0.666, 0.333], 4: [0.75, 0.25] },
    currentPattern: 1, pIndex: 0, beatCount: 0,
    
    targetQueue: [], vol: 0.5, 
    thresh: 0.012, 
    latency: 0.240,
    noteOn: false, noteStart: 0, lastHitId: -1,
    cycleHits: [], stars: 0,
    totalHits: 0,
    
    lastBeatIndex: -1,
    noiseWarningCounter: 0,
    
    isCalibrating: false,
    calibHits: [],
    calibNoisePeak: 0
};

const ui = {
    start: document.getElementById('btnStart'),
    stop: document.getElementById('btnStop'),
    restart: document.getElementById('btnRestart'),
    
    btnCalibStart: document.getElementById('btnCalibStart'),
    btnReCalib: document.getElementById('btnReCalib'),
    skipLink: document.getElementById('skipLink'),
    
    bpm: document.getElementById('inBpm'),
    groove: document.getElementById('grooveSelect'),
    canvas: document.getElementById('scope'),
    
    pendulum: document.getElementById('pendulumRod'),
    flashL: document.getElementById('flashL'),
    flashR: document.getElementById('flashR'),
    
    histArea: document.querySelector('.history-area'),
    hist: document.getElementById('histBody'),
    valTime: document.getElementById('valTime'), subTime: document.getElementById('subTime'), cardTime: document.getElementById('cardTime'),
    valLeg: document.getElementById('valLegato'), subLeg: document.getElementById('subLegato'), cardLeg: document.getElementById('cardLegato'),
    bar: document.getElementById('progressBar'), msg: document.getElementById('statusMsg'),
    stars: [document.getElementById('s1'), document.getElementById('s2'), document.getElementById('s3'), document.getElementById('s4')],
    inputLed: document.getElementById('inputLed'),
    inVol: document.getElementById('inVol'), inSens: document.getElementById('inSens'), inLat: document.getElementById('inLat'),
    
    overlay: document.getElementById('overlay'),
    ovTitle: document.getElementById('ovTitle'),
    ovDesc: document.getElementById('ovDesc'),
    calibCount: document.getElementById('calibCount')
};

// --- 1. SYSTEM INIT (Context Resume) ---
async function initAudio() {
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!engine.ctx) engine.ctx = new AC();
    
    // Force resume logic for iOS
    if (engine.ctx.state === 'suspended') {
        await engine.ctx.resume();
    }

    if (!engine.gain) {
        engine.gain = engine.ctx.createGain();
        engine.gain.connect(engine.ctx.destination);
    }

    if (!engine.mic) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: { echoCancellation: false, autoGainControl: false, noiseSuppression: false, latency: 0 }
            });
            engine.mic = engine.ctx.createMediaStreamSource(stream);
            engine.analyser = engine.ctx.createAnalyser();
            engine.analyser.fftSize = 1024;
            engine.mic.connect(engine.analyser);
        } catch(e) { 
            console.error(e);
            alert("Microphone Access Denied. Check Settings."); 
            return false; 
        }
    }
    return true;
}

// --- 2. CALIBRATION SEQUENCE ---
async function runCalibrationSequence(e) {
    // Prevent propagation (CRITICAL FIX for overlay disappearing)
    if(e) e.stopPropagation();
    
    ui.btnCalibStart.innerText = "Allow Mic...";
    ui.btnCalibStart.disabled = true;
    
    const ready = await initAudio();
    
    if(!ready) {
        ui.btnCalibStart.innerText = "Mic Error (Retry)";
        ui.btnCalibStart.disabled = false;
        return;
    }

    // Setup Calibration State
    engine.isCalibrating = true;
    engine.running = false; 
    engine.calibHits = [];
    engine.calibNoisePeak = 0;
    
    ui.btnCalibStart.style.display = 'none';
    ui.skipLink.style.display = 'none';
    ui.btnRestart.style.display = 'none';
    ui.ovTitle.innerText = "CALIBRATING";
    ui.ovDesc.innerText = "Keep quiet... Listening...";
    ui.calibCount.innerText = "READY";

    setTimeout(() => {
        let count = 0;
        const interval = setInterval(() => {
            count++;
            ui.calibCount.innerText = count + "/4";
            playTestClick();
            
            if (count >= 4) {
                clearInterval(interval);
                setTimeout(finalizeCalibration, 800);
            }
        }, 800);
        
        requestAnimationFrame(calibAnalysisLoop);
    }, 1000);
}

function playTestClick() {
    const osc = engine.ctx.createOscillator();
    const g = engine.ctx.createGain();
    osc.type = 'square';
    osc.frequency.value = 1000;
    g.gain.value = 1.0;
    osc.connect(g); g.connect(engine.gain);
    const now = engine.ctx.currentTime;
    osc.start(now); osc.stop(now + 0.05); 
    
    engine.calibHits.push({ send: now, recv: null });
}

function calibAnalysisLoop() {
    if(!engine.isCalibrating) return;
    
    const data = new Uint8Array(engine.analyser.frequencyBinCount);
    engine.analyser.getByteTimeDomainData(data);
    
    let sum = 0;
    for(let i=0; i<data.length; i++) { 
        const x = (data[i]-128)/128.0; 
        sum += x*x; 
    }
    const rms = Math.sqrt(sum / data.length);
    
    // Detect Latency (Loud click)
    if (rms > 0.05) {
        const now = engine.ctx.currentTime;
        const hit = engine.calibHits[engine.calibHits.length-1];
        if(hit && !hit.recv && (now - hit.send < 0.5)) {
            hit.recv = now;
        }
    }
    
    // Detect Background Noise
    if (rms > engine.calibNoisePeak) {
        engine.calibNoisePeak = rms;
    }
    
    requestAnimationFrame(calibAnalysisLoop);
}

function finalizeCalibration() {
    engine.isCalibrating = false;
    
    // Calc Latency
    let totalLat = 0;
    let validCount = 0;
    engine.calibHits.forEach(h => {
        if(h.recv) {
            totalLat += (h.recv - h.send);
            validCount++;
        }
    });
    
    let newLat = 0.240; 
    if (validCount > 0) {
        newLat = totalLat / validCount;
        if(newLat < 0.01) newLat = 0.01;
        if(newLat > 0.5) newLat = 0.5;
    }
    
    // Calc Sensitivity (Noise + Margin)
    let newThresh = engine.calibNoisePeak * 1.5;
    if (newThresh < 0.01) newThresh = 0.01;
    if (newThresh > 0.5) newThresh = 0.5;
    
    // Apply
    engine.latency = newLat;
    ui.inLat.value = Math.round(newLat * 1000);
    
    engine.thresh = newThresh;
    let sensVal = Math.round(newThresh * 500);
    if(sensVal > 50) sensVal = 50;
    if(sensVal < 1) sensVal = 1;
    ui.inSens.value = sensVal;
    
    closeOverlayAndStart();
}

function closeOverlayAndStart() {
    ui.overlay.style.display = 'none';
    
    // Reset Overlay for Game End
    ui.ovTitle.innerText = "CLEAR!";
    ui.ovDesc.innerText = "Excellent Rhythm & Control";
    ui.btnCalibStart.style.display = 'none';
    ui.skipLink.style.display = 'none';
    ui.btnRestart.style.display = 'block';
    ui.calibCount.innerText = "";
    
    startGame();
}

// --- GAME CONTROL ---
function startGame() {
    resetToReady();
    engine.running = true;
    engine.bpm = parseInt(ui.bpm.value);
    engine.currentPattern = parseInt(ui.groove.value);
    engine.pIndex = 0; engine.beatCount = 0; 
    
    engine.nextTime = engine.ctx.currentTime + 0.1;
    engine.startTime = engine.nextTime;
    
    engine.cycleHits = []; engine.targetQueue = [];
    
    engine.noteOn = false; 
    engine.noteStart = 0; 
    engine.lastHitId = -1; 
    engine.lastBeatIndex = -1;
    
    ui.start.style.display = 'none'; ui.stop.classList.add('active');
    scheduler(); detectionLoop();
}

// --- EVENT LISTENERS ---
ui.btnCalibStart.addEventListener('click', runCalibrationSequence);

ui.skipLink.addEventListener('click', async (e) => {
    if(e) e.stopPropagation();
    const ready = await initAudio();
    if(ready) closeOverlayAndStart();
});

ui.btnReCalib.addEventListener('click', () => {
    if(engine.running) {
        engine.running = false;
        clearTimeout(engine.timerID);
        ui.start.style.display = 'block'; ui.stop.classList.remove('active');
    }
    
    ui.overlay.style.display = 'flex';
    ui.ovTitle.innerText = "SETUP";
    ui.ovDesc.innerHTML = "Set volume MAX & unmute.<br>Tap to calibrate.";
    ui.btnCalibStart.innerText = "TAP TO START";
    ui.btnCalibStart.disabled = false;
    ui.btnCalibStart.style.display = 'block';
    ui.skipLink.style.display = 'block';
    ui.btnRestart.style.display = 'none';
    ui.calibCount.innerText = "";
});

ui.start.addEventListener('click', async () => {
    if(!engine.running) {
        const ready = await initAudio();
        if(ready) startGame();
    }
});

ui.stop.addEventListener('click', () => {
    engine.running = false; clearTimeout(engine.timerID);
    ui.start.style.display = 'block'; ui.stop.classList.remove('active');
    ui.msg.classList.remove('blink');
});

ui.restart.addEventListener('click', (e) => {
    if(e) e.stopPropagation();
    ui.overlay.style.display = 'none';
    resetToReady();
});

// Overlay click logic (Close if CLEAR screen, Ignore if Calib)
ui.overlay.addEventListener('click', (e) => {
    if(engine.isCalibrating) return;
    // If it's the CLEAR screen (restart btn visible)
    if(ui.btnRestart.style.display === 'block') {
        // Don't close if clicking the button itself (redundant but safe)
        if(e.target !== ui.btnRestart) {
            ui.overlay.style.display = 'none';
            resetToReady();
        }
    }
});

ui.groove.addEventListener('change', () => {
    engine.currentPattern = parseInt(ui.groove.value);
    engine.pIndex = 0; 
});

ui.inVol.addEventListener('input', e => { 
    let v = e.target.value / 100; 
    if(v <= 0) v = 0.0001; 
    engine.vol = v; 
    if(engine.gain) engine.gain.gain.value = engine.vol; 
});
ui.inSens.addEventListener('input', e => engine.thresh = e.target.value / 500);
ui.inLat.addEventListener('input', e => engine.latency = e.target.value / 1000);

function resize() { ui.canvas.width = ui.canvas.clientWidth; ui.canvas.height = ui.canvas.clientHeight; }
window.addEventListener('resize', resize); resize();
</script>
</body>
</html>
